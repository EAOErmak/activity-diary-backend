<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="
         http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.23.xsd">

    <!-- ======================================== -->
    <!-- USERS TABLE -->
    <!-- ======================================== -->
    <changeSet id="1-create-users" author="you">
        <createTable tableName="users">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>

            <column name="username" type="varchar(255)">
                <constraints nullable="false" unique="true"/>
            </column>

            <column name="password" type="varchar(255)">
                <constraints nullable="false"/>
            </column>

            <column name="full_name" type="varchar(255)">
                <constraints nullable="false"/>
            </column>

            <column name="enabled" type="boolean" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>

            <column name="chat_id" type="bigint"/>
            <column name="registration_ip" type="varchar(255)"/>

            <column name="role" type="varchar(50)">
                <constraints nullable="false"/>
            </column>

            <column name="created_at" type="timestamp"/>
            <column name="updated_at" type="timestamp"/>
        </createTable>
    </changeSet>


    <!-- ======================================== -->
    <!-- WHAT HAPPENED DICTIONARY -->
    <!-- ======================================== -->
    <changeSet id="2-create-what-happened" author="you">
        <createTable tableName="what_happened_dict">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>

            <column name="name" type="varchar(100)">
                <constraints nullable="false" unique="true"/>
            </column>

            <column name="is_active" type="boolean" defaultValueBoolean="true"/>
            <column name="created_at" type="timestamp"/>
            <column name="updated_at" type="timestamp"/>
        </createTable>
    </changeSet>


    <!-- ======================================== -->
    <!-- WHAT (SUBCATEGORY) -->
    <!-- ======================================== -->
    <changeSet id="3-create-what" author="you">
        <createTable tableName="what_dict">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>

            <column name="name" type="varchar(100)">
                <constraints nullable="false"/>
            </column>

            <column name="what_happened_id" type="bigint">
                <constraints nullable="false"
                             foreignKeyName="fk_what_parent"
                             referencedTableName="what_happened_dict"
                             referencedColumnNames="id"/>
            </column>

            <column name="is_active" type="boolean" defaultValueBoolean="true"/>

            <column name="created_at" type="timestamp"/>
            <column name="updated_at" type="timestamp"/>
        </createTable>

        <createIndex tableName="what_dict" indexName="idx_what_parent">
            <column name="what_happened_id"/>
        </createIndex>
    </changeSet>


    <!-- ======================================== -->
    <!-- ACTIVITY ITEM NAME DICT -->
    <!-- ======================================== -->
    <changeSet id="4-create-item-name" author="you">
        <createTable tableName="activity_item_name_dict">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>

            <column name="name" type="varchar(100)">
                <constraints nullable="false" unique="true"/>
            </column>

            <column name="is_active" type="boolean" defaultValueBoolean="true"/>

            <column name="created_at" type="timestamp"/>
            <column name="updated_at" type="timestamp"/>
        </createTable>
    </changeSet>


    <!-- ======================================== -->
    <!-- ACTIVITY ITEM UNIT DICT -->
    <!-- ======================================== -->
    <changeSet id="5-create-item-unit" author="you">
        <createTable tableName="activity_item_unit_dict">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>

            <column name="name" type="varchar(50)">
                <constraints nullable="false" unique="true"/>
            </column>

            <column name="is_active" type="boolean" defaultValueBoolean="true"/>

            <column name="created_at" type="timestamp"/>
            <column name="updated_at" type="timestamp"/>
        </createTable>
    </changeSet>


    <!-- ======================================== -->
    <!-- DIARY ENTRY -->
    <!-- ======================================== -->
    <changeSet id="6-create-diary-entry" author="you">
        <createTable tableName="diary_entry">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>

            <column name="what_happened_id" type="bigint">
                <constraints nullable="false"
                             foreignKeyName="fk_entry_wh"
                             referencedTableName="what_happened_dict"
                             referencedColumnNames="id"/>
            </column>

            <column name="what_id" type="bigint">
                <constraints nullable="false"
                             foreignKeyName="fk_entry_what"
                             referencedTableName="what_dict"
                             referencedColumnNames="id"/>
            </column>

            <column name="when_started" type="timestamp"/>
            <column name="when_ended" type="timestamp"/>
            <column name="duration" type="int"/>

            <column name="how_you_were_feeling" type="smallint"/>
            <column name="any_description" type="varchar(1000)"/>

            <column name="status" type="varchar(50)" defaultValue="ACTIVE"/>

            <column name="user_id" type="bigint">
                <constraints nullable="false"
                             foreignKeyName="fk_entry_user"
                             referencedTableName="users"
                             referencedColumnNames="id"/>
            </column>

            <column name="created_at" type="timestamp"/>
            <column name="updated_at" type="timestamp"/>
        </createTable>

        <createIndex tableName="diary_entry" indexName="idx_entry_user">
            <column name="user_id"/>
        </createIndex>

        <createIndex tableName="diary_entry" indexName="idx_entry_started">
            <column name="when_started"/>
        </createIndex>

        <createIndex tableName="diary_entry" indexName="idx_entry_ended">
            <column name="when_ended"/>
        </createIndex>
    </changeSet>


    <!-- ======================================== -->
    <!-- ACTIVITY ITEM -->
    <!-- ======================================== -->
    <changeSet id="7-create-activity-item" author="you">
        <createTable tableName="activity_item">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>

            <column name="dict_name_id" type="bigint">
                <constraints nullable="false"
                             foreignKeyName="fk_item_name"
                             referencedTableName="activity_item_name_dict"
                             referencedColumnNames="id"/>
            </column>

            <column name="dict_unit_id" type="bigint">
                <constraints nullable="false"
                             foreignKeyName="fk_item_unit"
                             referencedTableName="activity_item_unit_dict"
                             referencedColumnNames="id"/>
            </column>

            <column name="count" type="int"/>

            <column name="diary_entry_id" type="bigint">
                <constraints nullable="false"
                             foreignKeyName="fk_item_entry"
                             referencedTableName="diary_entry"
                             referencedColumnNames="id"/>
            </column>
        </createTable>
    </changeSet>


    <!-- ======================================== -->
    <!-- REFRESH TOKEN -->
    <!-- ======================================== -->
    <changeSet id="8-create-refresh-token" author="you">
        <createTable tableName="refresh_token">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>

            <column name="user_id" type="bigint">
                <constraints nullable="false"
                             foreignKeyName="fk_rt_user"
                             referencedTableName="users"
                             referencedColumnNames="id"/>
            </column>

            <column name="token_hash" type="varchar(255)">
                <constraints nullable="false" unique="true"/>
            </column>

            <column name="created_at" type="timestamp"/>
            <column name="expires_at" type="timestamp"/>
            <column name="revoked" type="boolean" defaultValueBoolean="false"/>
            <column name="replaced_by" type="bigint"/>
        </createTable>
    </changeSet>

</databaseChangeLog>
